flowchart TD
    A[開始] --> H[メインループ開始]
    
    H --> I{フレーム取得}
    I --> J[AIモデルで人物検出]
    J --> K[検出結果と追跡中人物のマッチング]
    
    K --> L{新規人物?}
    L -- Yes --> M[新規Person作成]
    L -- No --> N{既存人物?}
    
    N -- Yes --> O[Person情報更新]
    N -- No --> P{ロスト人物?}
    
    P -- Yes --> Q[復帰判定]
    Q --> R{復帰可能?}
    R -- Yes --> S[ロストから復帰]
    R -- No --> T[ロスト継続/削除]
    
    M --> U[中央ライン通過チェック]
    O --> U
    S --> U
    
    U --> V{ライン通過?}
    V -- Yes --> W[方向判定・カウント]
    V -- No --> X[次フレーム処理]
    W --> X
    T --> X
    
    X --> Y{定期保存タイミング?}
    Y -- Yes --> Z[JSONファイル保存]
    Y -- No --> I
    Z --> I
    
    subgraph "フレーム描画処理"
    AA[センターライン描画]
    BB[人物ボックス描画]
    CC[軌跡描画]
    DD[カウント情報表示]
    EE[映像配信]
    end
    
    K --> AA
    AA --> BB
    BB --> CC
    CC --> DD
    DD --> EE